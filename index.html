<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <title>EC Mail Desk - EC店舗メール管理</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #6c5ce7;
      --primary-dark: #5a4bd1;
      --primary-light: #a29bfe;
      --rakuten: #bf0000;
      --yahoo: #ff0033;
      --other: #0984e3;
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #2d3436;
      --text-secondary: #636e72;
      --border: #dfe6e9;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --radius: 12px;
      --success: #00b894;
      --warning: #fdcb6e;
      --danger: #e17055;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    /* Layout */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header h1 span {
      color: var(--primary-light);
    }

    .header-badge {
      font-size: 11px;
      background: var(--primary);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background 0.2s;
    }

    .header-btn:hover { background: rgba(255,255,255,0.2); }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar - Mail List */
    .mail-sidebar {
      width: 360px;
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* Platform Tabs */
    .platform-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .platform-tab {
      flex: 1;
      padding: 10px 8px;
      border: none;
      background: none;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .platform-tab.active { color: var(--primary); }

    .platform-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 10%;
      right: 10%;
      height: 3px;
      background: var(--primary);
      border-radius: 3px 3px 0 0;
    }

    .platform-tab .tab-count {
      font-size: 10px;
      background: var(--bg);
      padding: 1px 6px;
      border-radius: 8px;
      color: var(--text-secondary);
    }

    .platform-tab.active .tab-count {
      background: var(--primary);
      color: white;
    }

    /* Search */
    .search-bar {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-input:focus { outline: none; border-color: var(--primary); }

    /* Mail List */
    .mail-list {
      flex: 1;
      overflow-y: auto;
    }

    .mail-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }

    .mail-item:hover { background: #f8f9fa; }
    .mail-item.active { background: #ede9fe; }
    .mail-item.unread { background: #fafbff; }

    .mail-item.unread::before {
      content: '';
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
    }

    .mail-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .mail-sender {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .mail-item.unread .mail-sender { font-weight: 700; }

    .mail-time {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .mail-subject {
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .mail-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mail-tags {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }

    .mail-tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .tag-rakuten { background: #ffeaea; color: var(--rakuten); }
    .tag-yahoo { background: #ffe5e9; color: var(--yahoo); }
    .tag-other { background: #e3f2fd; color: var(--other); }
    .tag-replied { background: #e6fff6; color: var(--success); }
    .tag-pending { background: #fff8e1; color: #e17055; }

    /* Mail Detail */
    .mail-detail {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .mail-detail-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      gap: 12px;
    }

    .mail-detail-empty .empty-icon {
      font-size: 64px;
      opacity: 0.3;
    }

    .mail-detail-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .detail-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .detail-subject {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .detail-meta {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .detail-meta strong { color: var(--text); }

    .detail-body-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .detail-body {
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Reply Section */
    .reply-section {
      border-top: 1px solid var(--border);
      padding: 16px 24px;
      background: #fafbfc;
      flex-shrink: 0;
    }

    .reply-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      background: var(--card);
      color: var(--text);
      border: 1.5px solid var(--border);
    }

    .btn-secondary:hover { background: var(--bg); }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover { background: #00a381; }

    .reply-textarea {
      width: 100%;
      min-height: 120px;
      max-height: 300px;
      padding: 12px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.7;
      resize: vertical;
      color: var(--text);
    }

    .reply-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .reply-status {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .generating-indicator {
      display: inline-flex;
      gap: 3px;
      align-items: center;
    }

    .generating-indicator span {
      width: 4px;
      height: 4px;
      background: var(--primary);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }

    .generating-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .generating-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Bottom Nav (Mobile) */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      justify-content: space-around;
      padding: 6px 0;
      padding-bottom: max(6px, env(safe-area-inset-bottom));
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 4px 12px;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 10px;
      cursor: pointer;
    }

    .nav-item.active { color: var(--primary); }
    .nav-item svg { width: 22px; height: 22px; }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--card);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal h2 {
      font-size: 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-close {
      margin-left: auto;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--text-secondary);
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover { background: var(--bg); }

    /* Form */
    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.7;
    }

    /* Knowledge Base */
    .knowledge-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .knowledge-item {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px 16px;
      position: relative;
    }

    .knowledge-item-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .knowledge-item-category {
      font-size: 11px;
      padding: 1px 8px;
      border-radius: 6px;
      background: var(--primary);
      color: white;
    }

    .knowledge-item-body {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 80px;
      overflow: hidden;
    }

    .knowledge-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .knowledge-item-actions button {
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      font-size: 12px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .knowledge-item-actions button:hover { background: var(--border); }
    .knowledge-item-actions .btn-delete:hover { background: #ffeaea; color: var(--danger); }

    /* Settings */
    .settings-section {
      margin-bottom: 20px;
    }

    .settings-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .api-key-input {
      font-family: monospace;
    }

    .settings-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .mail-sidebar {
        width: 100%;
        display: none;
      }

      .mail-sidebar.mobile-show { display: flex; }

      .mail-detail {
        display: none;
      }

      .mail-detail.mobile-show { display: flex; }

      .bottom-nav { display: flex; }

      body { padding-bottom: 56px; }

      .detail-header { padding: 12px 16px; }
      .detail-body-wrapper { padding: 12px 16px; }
      .reply-section { padding: 12px 16px; }

      .mobile-back {
        display: flex !important;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: var(--primary);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        padding: 4px 0;
        margin-bottom: 8px;
      }
    }

    @media (min-width: 769px) {
      .mobile-back { display: none; }
      .mail-sidebar { display: flex !important; }
      .mail-detail { display: flex !important; }
    }

    /* Add Email FAB */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 26px;
      box-shadow: 0 4px 16px rgba(108,92,231,0.4);
      cursor: pointer;
      z-index: 90;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .fab:active { transform: scale(0.9); }

    @media (max-width: 768px) {
      .fab { bottom: 72px; }
    }

    /* View Panels for Knowledge & Settings */
    .side-panel {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .side-panel.active {
      display: flex;
    }

    .panel-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-header h2 {
      font-size: 18px;
      font-weight: 700;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .panel-body .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>EC <span>Mail Desk</span></h1>
      </div>
      <div class="header-actions">
        <a href="./tasks.html" class="header-btn" title="タスク管理" style="text-decoration:none">&#x2705;</a>
        <button class="header-btn" onclick="showView('inbox')" title="受信トレイ">&#x1F4E8;</button>
        <button class="header-btn" onclick="showView('knowledge')" title="ナレッジ">&#x1F4DA;</button>
        <button class="header-btn" onclick="openSettings()" title="設定">&#x2699;</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar: Mail List -->
      <div class="mail-sidebar mobile-show" id="mailSidebar">
        <div class="platform-tabs">
          <button class="platform-tab active" data-platform="all" onclick="filterPlatform('all')">
            すべて <span class="tab-count" id="countAll">0</span>
          </button>
          <button class="platform-tab" data-platform="rakuten" onclick="filterPlatform('rakuten')">
            楽天 <span class="tab-count" id="countRakuten">0</span>
          </button>
          <button class="platform-tab" data-platform="yahoo" onclick="filterPlatform('yahoo')">
            Yahoo <span class="tab-count" id="countYahoo">0</span>
          </button>
          <button class="platform-tab" data-platform="other" onclick="filterPlatform('other')">
            その他 <span class="tab-count" id="countOther">0</span>
          </button>
        </div>
        <div class="search-bar">
          <input type="text" class="search-input" id="searchInput" placeholder="メールを検索..." oninput="renderMailList()">
        </div>
        <div class="mail-list" id="mailList"></div>
      </div>

      <!-- Mail Detail (default view) -->
      <div class="mail-detail" id="mailDetailPanel">
        <div class="mail-detail-empty" id="mailEmpty">
          <div class="empty-icon">&#x1F4EC;</div>
          <p>メールを選択してください</p>
          <p style="font-size:12px">左のリストからメールを選ぶか、「+」で新規追加</p>
        </div>
        <div class="mail-detail-content" id="mailDetailContent" style="display:none">
          <div class="detail-header">
            <button class="mobile-back" onclick="mobileBack()">&#x2190; 戻る</button>
            <div class="detail-subject" id="detailSubject"></div>
            <div class="detail-meta" id="detailMeta"></div>
          </div>
          <div class="detail-body-wrapper">
            <div class="detail-body" id="detailBody"></div>
          </div>
          <div class="reply-section">
            <div class="reply-actions">
              <button class="btn btn-primary" onclick="generateReply()" id="generateBtn">
                &#x2728; 返信を作成
              </button>
              <button class="btn btn-secondary" onclick="clearReply()">クリア</button>
              <button class="btn btn-success" onclick="markReplied()" id="sendBtn" style="margin-left:auto">
                &#x2714; 返信済みにする
              </button>
            </div>
            <textarea class="reply-textarea" id="replyText" placeholder="ここに返信文が生成されます。手動で編集も可能です。"></textarea>
            <div class="reply-status" id="replyStatus"></div>
          </div>
        </div>
      </div>

      <!-- Knowledge Panel -->
      <div class="side-panel" id="knowledgePanel">
        <div class="panel-header">
          <h2>&#x1F4DA; ナレッジベース</h2>
          <button class="btn btn-primary" onclick="openKnowledgeModal()">+ 追加</button>
        </div>
        <div class="panel-body">
          <div class="knowledge-list" id="knowledgeList"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Nav (Mobile) -->
    <div class="bottom-nav">
      <button class="nav-item active" data-nav="inbox" onclick="showView('inbox')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
        受信
      </button>
      <button class="nav-item" data-nav="knowledge" onclick="showView('knowledge')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
        ナレッジ
      </button>
      <button class="nav-item" data-nav="settings" onclick="openSettings()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        設定
      </button>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openAddMailModal()" title="メールを追加">+</button>

  <!-- Add Mail Modal -->
  <div class="modal-overlay" id="addMailModal">
    <div class="modal">
      <h2>&#x1F4E9; メールを追加 <button class="modal-close" onclick="closeModal('addMailModal')">&times;</button></h2>
      <form onsubmit="addMail(event)">
        <div class="form-group">
          <label>プラットフォーム</label>
          <select id="mailPlatform">
            <option value="rakuten">楽天RMS</option>
            <option value="yahoo">Yahoo!ストアクリエーター</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div class="form-group">
          <label>送信者名</label>
          <input type="text" id="mailSender" placeholder="例: 山田太郎 様" required>
        </div>
        <div class="form-group">
          <label>メールアドレス</label>
          <input type="email" id="mailEmail" placeholder="例: yamada@example.com">
        </div>
        <div class="form-group">
          <label>件名</label>
          <input type="text" id="mailSubject" placeholder="例: 商品の返品について" required>
        </div>
        <div class="form-group">
          <label>本文</label>
          <textarea id="mailBody" placeholder="メール本文を貼り付けてください" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:12px">追加する</button>
      </form>
    </div>
  </div>

  <!-- Knowledge Modal -->
  <div class="modal-overlay" id="knowledgeModal">
    <div class="modal">
      <h2>&#x1F4DD; ナレッジ追加 <button class="modal-close" onclick="closeModal('knowledgeModal')">&times;</button></h2>
      <form onsubmit="addKnowledge(event)">
        <div class="form-group">
          <label>カテゴリ</label>
          <select id="knowledgeCategory">
            <option value="返品・返金">返品・返金</option>
            <option value="配送・送料">配送・送料</option>
            <option value="在庫・入荷">在庫・入荷</option>
            <option value="商品不良">商品不良</option>
            <option value="注文変更">注文変更</option>
            <option value="クーポン・ポイント">クーポン・ポイント</option>
            <option value="挨拶・お礼">挨拶・お礼</option>
            <option value="その他">その他</option>
          </select>
        </div>
        <div class="form-group">
          <label>タイトル（キーワード）</label>
          <input type="text" id="knowledgeTitle" placeholder="例: 返品ポリシー" required>
        </div>
        <div class="form-group">
          <label>内容（テンプレート返信文）</label>
          <textarea id="knowledgeBody" placeholder="このナレッジに基づいて返信が生成されます" required style="min-height:160px"></textarea>
        </div>
        <input type="hidden" id="knowledgeEditId" value="">
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:12px" id="knowledgeSubmitBtn">追加する</button>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>&#x2699; 設定 <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button></h2>
      <div class="settings-section">
        <h3>AI API設定（任意）</h3>
        <div class="form-group">
          <label>APIキー（OpenAI or Anthropic）</label>
          <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-... or sk-ant-...">
        </div>
        <div class="form-group">
          <label>APIプロバイダ</label>
          <select id="apiProvider">
            <option value="none">使用しない（ナレッジのみ）</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="anthropic">Anthropic (Claude)</option>
          </select>
        </div>
        <p class="settings-note">APIキーはブラウザのローカルストレージに保存され、外部には送信されません（API呼び出し時を除く）。<br>APIを設定しない場合、ナレッジベースからのテンプレートマッチングで返信を生成します。</p>
      </div>
      <div class="settings-section">
        <h3>店舗情報</h3>
        <div class="form-group">
          <label>店舗名</label>
          <input type="text" id="shopName" placeholder="例: ○○ショップ">
        </div>
        <div class="form-group">
          <label>署名（返信末尾に付与）</label>
          <textarea id="shopSignature" placeholder="例:&#10;─────────────&#10;○○ショップ カスタマーサポート&#10;TEL: 03-XXXX-XXXX&#10;営業時間: 平日 9:00〜18:00" style="min-height:100px"></textarea>
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px" onclick="saveSettings()">保存する</button>
    </div>
  </div>

  <script>
    // ===== State =====
    let emails = JSON.parse(localStorage.getItem('ecmaildesk_emails') || '[]');
    let knowledge = JSON.parse(localStorage.getItem('ecmaildesk_knowledge') || '[]');
    let settings = JSON.parse(localStorage.getItem('ecmaildesk_settings') || '{}');
    let currentPlatform = 'all';
    let selectedMailId = null;
    let currentView = 'inbox';

    // ===== Init =====
    function init() {
      // Load sample knowledge if empty
      if (knowledge.length === 0) {
        knowledge = [
          {
            id: 'k1', category: '返品・返金',
            title: '返品対応の基本テンプレート',
            body: 'この度はご不便をおかけし、誠に申し訳ございません。\n返品につきまして、以下の手順でお手続きをお願いいたします。\n\n1. 商品到着後7日以内にご連絡ください\n2. 未開封・未使用の場合のみ返品を承ります\n3. 返送料はお客様負担となります\n\n返品確認後、3〜5営業日以内にご返金いたします。'
          },
          {
            id: 'k2', category: '配送・送料',
            title: '配送状況の確認テンプレート',
            body: 'お問い合わせいただきありがとうございます。\n配送状況を確認いたしましたところ、お荷物は現在【配送状況】となっております。\n\nお届け予定日: 【日付】\n追跡番号: 【番号】\n\n配送に遅延が発生している場合は、配送業者に確認の上、改めてご連絡いたします。'
          },
          {
            id: 'k3', category: '商品不良',
            title: '商品不良時の対応テンプレート',
            body: 'この度はご迷惑をおかけし、大変申し訳ございません。\n商品の不良について確認させていただきたく存じます。\n\nお手数ですが、以下の情報をお知らせいただけますでしょうか。\n・不良箇所の写真\n・ご注文番号\n\n確認次第、交換品の発送または返金にて対応させていただきます。'
          },
          {
            id: 'k4', category: '挨拶・お礼',
            title: '購入お礼テンプレート',
            body: 'この度は当店をご利用いただき、誠にありがとうございます。\n商品はお気に召していただけましたでしょうか。\n\nもしご不明な点やお気づきの点がございましたら、お気軽にお問い合わせください。\nまたのご利用を心よりお待ちしております。'
          }
        ];
        saveKnowledge();
      }

      // Load settings
      if (settings.apiKey) document.getElementById('apiKeyInput').value = settings.apiKey;
      if (settings.apiProvider) document.getElementById('apiProvider').value = settings.apiProvider;
      if (settings.shopName) document.getElementById('shopName').value = settings.shopName;
      if (settings.shopSignature) document.getElementById('shopSignature').value = settings.shopSignature;

      renderMailList();
      renderKnowledgeList();
      updateCounts();
    }

    // ===== Save Functions =====
    function saveEmails() {
      localStorage.setItem('ecmaildesk_emails', JSON.stringify(emails));
    }

    function saveKnowledge() {
      localStorage.setItem('ecmaildesk_knowledge', JSON.stringify(knowledge));
    }

    function saveSettings() {
      settings = {
        apiKey: document.getElementById('apiKeyInput').value.trim(),
        apiProvider: document.getElementById('apiProvider').value,
        shopName: document.getElementById('shopName').value.trim(),
        shopSignature: document.getElementById('shopSignature').value.trim()
      };
      localStorage.setItem('ecmaildesk_settings', JSON.stringify(settings));
      closeModal('settingsModal');
      alert('設定を保存しました');
    }

    // ===== View Management =====
    function showView(view) {
      currentView = view;

      // Update nav
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const navBtn = document.querySelector(`[data-nav="${view}"]`);
      if (navBtn) navBtn.classList.add('active');

      // Toggle panels
      document.getElementById('mailSidebar').style.display = '';
      document.getElementById('mailDetailPanel').style.display = '';
      document.getElementById('knowledgePanel').classList.remove('active');

      if (view === 'inbox') {
        document.getElementById('mailSidebar').classList.add('mobile-show');
        document.getElementById('mailDetailPanel').style.display = '';
        document.getElementById('knowledgePanel').classList.remove('active');
      } else if (view === 'knowledge') {
        if (window.innerWidth <= 768) {
          document.getElementById('mailSidebar').classList.remove('mobile-show');
          document.getElementById('mailDetailPanel').style.display = 'none';
        } else {
          document.getElementById('mailDetailPanel').style.display = 'none';
        }
        document.getElementById('knowledgePanel').classList.add('active');
      }
    }

    function mobileBack() {
      document.getElementById('mailSidebar').classList.add('mobile-show');
      document.getElementById('mailDetailPanel').classList.remove('mobile-show');
    }

    // ===== Platform Filter =====
    function filterPlatform(platform) {
      currentPlatform = platform;
      document.querySelectorAll('.platform-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-platform="${platform}"]`).classList.add('active');
      renderMailList();
    }

    // ===== Render Mail List =====
    function renderMailList() {
      const list = document.getElementById('mailList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      let filtered = [...emails];

      if (currentPlatform !== 'all') {
        filtered = filtered.filter(m => m.platform === currentPlatform);
      }

      if (search) {
        filtered = filtered.filter(m =>
          m.sender.toLowerCase().includes(search) ||
          m.subject.toLowerCase().includes(search) ||
          m.body.toLowerCase().includes(search)
        );
      }

      filtered.sort((a, b) => b.createdAt - a.createdAt);

      if (filtered.length === 0) {
        list.innerHTML = `
          <div style="text-align:center;padding:40px 20px;color:var(--text-secondary)">
            <div style="font-size:40px;margin-bottom:8px;opacity:0.3">&#x1F4EC;</div>
            <p style="font-size:13px">メールがありません</p>
            <p style="font-size:12px;margin-top:4px">「+」ボタンから追加してください</p>
          </div>`;
        return;
      }

      const platformTags = {
        rakuten: '<span class="mail-tag tag-rakuten">楽天</span>',
        yahoo: '<span class="mail-tag tag-yahoo">Yahoo</span>',
        other: '<span class="mail-tag tag-other">その他</span>'
      };

      list.innerHTML = filtered.map(mail => `
        <div class="mail-item ${mail.id === selectedMailId ? 'active' : ''} ${mail.read ? '' : 'unread'}"
             onclick="selectMail('${mail.id}')">
          <div class="mail-item-header">
            <span class="mail-sender">${escapeHtml(mail.sender)}</span>
            <span class="mail-time">${formatTime(mail.createdAt)}</span>
          </div>
          <div class="mail-subject">${escapeHtml(mail.subject)}</div>
          <div class="mail-preview">${escapeHtml(mail.body.substring(0, 60))}</div>
          <div class="mail-tags">
            ${platformTags[mail.platform] || ''}
            ${mail.replied ? '<span class="mail-tag tag-replied">返信済</span>' : '<span class="mail-tag tag-pending">未返信</span>'}
          </div>
        </div>
      `).join('');

      updateCounts();
    }

    // ===== Select Mail =====
    function selectMail(id) {
      selectedMailId = id;
      const mail = emails.find(m => m.id === id);
      if (!mail) return;

      mail.read = true;
      saveEmails();

      document.getElementById('mailEmpty').style.display = 'none';
      document.getElementById('mailDetailContent').style.display = 'flex';

      document.getElementById('detailSubject').textContent = mail.subject;

      const platformNames = { rakuten: '楽天RMS', yahoo: 'Yahoo!ストア', other: 'その他' };
      document.getElementById('detailMeta').innerHTML = `
        <span><strong>送信者:</strong> ${escapeHtml(mail.sender)} ${mail.email ? '&lt;' + escapeHtml(mail.email) + '&gt;' : ''}</span>
        <span><strong>プラットフォーム:</strong> ${platformNames[mail.platform] || mail.platform}</span>
        <span><strong>受信:</strong> ${new Date(mail.createdAt).toLocaleString('ja-JP')}</span>
      `;

      document.getElementById('detailBody').textContent = mail.body;
      document.getElementById('replyText').value = mail.replyDraft || '';
      document.getElementById('replyStatus').textContent = '';

      // Mobile: show detail
      if (window.innerWidth <= 768) {
        document.getElementById('mailSidebar').classList.remove('mobile-show');
        document.getElementById('mailDetailPanel').classList.add('mobile-show');
      }

      renderMailList();
    }

    // ===== Add Mail =====
    function addMail(e) {
      e.preventDefault();
      const mail = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        platform: document.getElementById('mailPlatform').value,
        sender: document.getElementById('mailSender').value.trim(),
        email: document.getElementById('mailEmail').value.trim(),
        subject: document.getElementById('mailSubject').value.trim(),
        body: document.getElementById('mailBody').value.trim(),
        read: false,
        replied: false,
        replyDraft: '',
        createdAt: Date.now()
      };

      emails.unshift(mail);
      saveEmails();
      closeModal('addMailModal');
      e.target.reset();
      renderMailList();
      updateCounts();
    }

    // ===== Generate Reply =====
    async function generateReply() {
      const mail = emails.find(m => m.id === selectedMailId);
      if (!mail) return;

      const btn = document.getElementById('generateBtn');
      const status = document.getElementById('replyStatus');

      btn.disabled = true;
      status.innerHTML = '<span class="generating-indicator"><span></span><span></span><span></span></span> 返信を生成中...';

      try {
        let reply = '';

        if (settings.apiProvider === 'openai' && settings.apiKey) {
          reply = await generateWithOpenAI(mail);
        } else if (settings.apiProvider === 'anthropic' && settings.apiKey) {
          reply = await generateWithAnthropic(mail);
        } else {
          reply = generateFromKnowledge(mail);
        }

        // Add signature
        if (settings.shopSignature) {
          reply += '\n\n' + settings.shopSignature;
        }

        document.getElementById('replyText').value = reply;
        mail.replyDraft = reply;
        saveEmails();
        status.textContent = '&#x2714; 生成完了';

      } catch (err) {
        status.textContent = 'エラー: ' + err.message;
      }

      btn.disabled = false;
    }

    // ===== Knowledge-based Reply =====
    function generateFromKnowledge(mail) {
      const text = (mail.subject + ' ' + mail.body).toLowerCase();

      // Keyword matching
      const keywords = {
        '返品': ['返品', '返金', '返送', 'キャンセル', '取り消し'],
        '配送': ['配送', '届か', '届い', '発送', '送料', '追跡', '遅延', '遅い'],
        '在庫': ['在庫', '入荷', '品切', '売り切', '再入荷'],
        '不良': ['不良', '壊れ', '破損', '傷', '汚れ', '違う商品', '間違'],
        '変更': ['変更', 'キャンセル', '住所', '数量'],
        'クーポン': ['クーポン', 'ポイント', '割引', 'セール'],
        'お礼': ['ありがとう', 'お礼', '感謝', 'レビュー']
      };

      const categoryMap = {
        '返品': '返品・返金',
        '配送': '配送・送料',
        '在庫': '在庫・入荷',
        '不良': '商品不良',
        '変更': '注文変更',
        'クーポン': 'クーポン・ポイント',
        'お礼': '挨拶・お礼'
      };

      // Find best matching category
      let bestCategory = null;
      let bestScore = 0;

      for (const [key, words] of Object.entries(keywords)) {
        const score = words.filter(w => text.includes(w)).length;
        if (score > bestScore) {
          bestScore = score;
          bestCategory = categoryMap[key];
        }
      }

      // Find matching knowledge
      let matchedKnowledge = [];
      if (bestCategory) {
        matchedKnowledge = knowledge.filter(k => k.category === bestCategory);
      }

      if (matchedKnowledge.length === 0) {
        matchedKnowledge = knowledge;
      }

      // Build reply
      const shopName = settings.shopName || '当店';
      const senderName = mail.sender.replace(/\s*様$/, '');

      let reply = `${senderName} 様\n\nお問い合わせいただきありがとうございます。\n${shopName}カスタマーサポートでございます。\n\n`;

      if (matchedKnowledge.length > 0) {
        reply += matchedKnowledge[0].body;
      } else {
        reply += 'お問い合わせ内容を確認いたしました。\n詳細を確認の上、改めてご連絡させていただきます。\n\n何卒よろしくお願いいたします。';
      }

      reply += `\n\n${shopName}`;

      return reply;
    }

    // ===== OpenAI API =====
    async function generateWithOpenAI(mail) {
      const knowledgeContext = knowledge.map(k =>
        `【${k.category}】${k.title}\n${k.body}`
      ).join('\n\n---\n\n');

      const shopName = settings.shopName || '当店';

      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + settings.apiKey
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: `あなたはEC店舗「${shopName}」のカスタマーサポートです。以下のナレッジベースを参照して、丁寧で適切な返信メールを作成してください。\n\n【ナレッジベース】\n${knowledgeContext}`
            },
            {
              role: 'user',
              content: `以下のお客様メールに対する返信を作成してください。\n\n送信者: ${mail.sender}\n件名: ${mail.subject}\n本文:\n${mail.body}`
            }
          ],
          temperature: 0.7,
          max_tokens: 1000
        })
      });

      if (!res.ok) throw new Error('API呼び出しに失敗しました');
      const data = await res.json();
      return data.choices[0].message.content;
    }

    // ===== Anthropic API =====
    async function generateWithAnthropic(mail) {
      const knowledgeContext = knowledge.map(k =>
        `【${k.category}】${k.title}\n${k.body}`
      ).join('\n\n---\n\n');

      const shopName = settings.shopName || '当店';

      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': settings.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 1000,
          system: `あなたはEC店舗「${shopName}」のカスタマーサポートです。以下のナレッジベースを参照して、丁寧で適切な返信メールを作成してください。\n\n【ナレッジベース】\n${knowledgeContext}`,
          messages: [
            {
              role: 'user',
              content: `以下のお客様メールに対する返信を作成してください。\n\n送信者: ${mail.sender}\n件名: ${mail.subject}\n本文:\n${mail.body}`
            }
          ]
        })
      });

      if (!res.ok) throw new Error('API呼び出しに失敗しました');
      const data = await res.json();
      return data.content[0].text;
    }

    // ===== Mark Replied =====
    function markReplied() {
      const mail = emails.find(m => m.id === selectedMailId);
      if (!mail) return;

      const replyText = document.getElementById('replyText').value.trim();
      if (!replyText) {
        alert('返信文を入力または生成してください');
        return;
      }

      mail.replied = true;
      mail.replyDraft = replyText;
      mail.repliedAt = Date.now();
      saveEmails();
      renderMailList();
      document.getElementById('replyStatus').textContent = '&#x2714; 返信済みにしました';
    }

    function clearReply() {
      document.getElementById('replyText').value = '';
      document.getElementById('replyStatus').textContent = '';
    }

    // ===== Knowledge =====
    function renderKnowledgeList() {
      const list = document.getElementById('knowledgeList');

      if (knowledge.length === 0) {
        list.innerHTML = '<div class="empty-state"><p>ナレッジがありません</p></div>';
        return;
      }

      list.innerHTML = knowledge.map(k => `
        <div class="knowledge-item">
          <div class="knowledge-item-title">
            ${escapeHtml(k.title)}
            <span class="knowledge-item-category">${escapeHtml(k.category)}</span>
          </div>
          <div class="knowledge-item-body">${escapeHtml(k.body)}</div>
          <div class="knowledge-item-actions">
            <button onclick="editKnowledge('${k.id}')">編集</button>
            <button class="btn-delete" onclick="deleteKnowledge('${k.id}')">削除</button>
          </div>
        </div>
      `).join('');
    }

    function openKnowledgeModal() {
      document.getElementById('knowledgeEditId').value = '';
      document.getElementById('knowledgeSubmitBtn').textContent = '追加する';
      document.getElementById('knowledgeModal').querySelector('h2').innerHTML =
        '&#x1F4DD; ナレッジ追加 <button class="modal-close" onclick="closeModal(\'knowledgeModal\')">&times;</button>';
      document.getElementById('knowledgeModal').classList.add('active');
    }

    function addKnowledge(e) {
      e.preventDefault();
      const editId = document.getElementById('knowledgeEditId').value;
      const item = {
        id: editId || Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        category: document.getElementById('knowledgeCategory').value,
        title: document.getElementById('knowledgeTitle').value.trim(),
        body: document.getElementById('knowledgeBody').value.trim()
      };

      if (editId) {
        const idx = knowledge.findIndex(k => k.id === editId);
        if (idx >= 0) knowledge[idx] = item;
      } else {
        knowledge.push(item);
      }

      saveKnowledge();
      closeModal('knowledgeModal');
      e.target.reset();
      document.getElementById('knowledgeEditId').value = '';
      renderKnowledgeList();
    }

    function editKnowledge(id) {
      const k = knowledge.find(item => item.id === id);
      if (!k) return;

      document.getElementById('knowledgeEditId').value = k.id;
      document.getElementById('knowledgeCategory').value = k.category;
      document.getElementById('knowledgeTitle').value = k.title;
      document.getElementById('knowledgeBody').value = k.body;
      document.getElementById('knowledgeSubmitBtn').textContent = '更新する';
      document.getElementById('knowledgeModal').querySelector('h2').innerHTML =
        '&#x1F4DD; ナレッジ編集 <button class="modal-close" onclick="closeModal(\'knowledgeModal\')">&times;</button>';
      document.getElementById('knowledgeModal').classList.add('active');
    }

    function deleteKnowledge(id) {
      if (!confirm('このナレッジを削除しますか？')) return;
      knowledge = knowledge.filter(k => k.id !== id);
      saveKnowledge();
      renderKnowledgeList();
    }

    // ===== Counts =====
    function updateCounts() {
      document.getElementById('countAll').textContent = emails.length;
      document.getElementById('countRakuten').textContent = emails.filter(m => m.platform === 'rakuten').length;
      document.getElementById('countYahoo').textContent = emails.filter(m => m.platform === 'yahoo').length;
      document.getElementById('countOther').textContent = emails.filter(m => m.platform === 'other').length;
    }

    // ===== Modals =====
    function openAddMailModal() { document.getElementById('addMailModal').classList.add('active'); }
    function openSettings() { document.getElementById('settingsModal').classList.add('active'); }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) overlay.classList.remove('active');
      });
    });

    // ===== Utilities =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(ts) {
      const d = new Date(ts);
      const now = new Date();
      const diffMs = now - d;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);

      if (diffMins < 1) return 'たった今';
      if (diffMins < 60) return diffMins + '分前';
      if (diffHours < 24) return diffHours + '時間前';

      const isThisYear = d.getFullYear() === now.getFullYear();
      if (isThisYear) return `${d.getMonth()+1}/${d.getDate()}`;
      return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // Init
    init();
  </script>
</body>
</html>
